const matchEscSqlRx=/[\0\b\t\n\r\x1a"'\\]/g;function escapeSql(b){const f=matchEscSqlRx.exec(b);if(!f)return b;let c=matchEscSqlRx.lastIndex=0,e="",d,a;while(d=matchEscSqlRx.exec(b)){switch(d[0]){case"\0":a="\\0";break;case"":a="\\b";break;case"	":a="\\t";break;case"":a="\\z";break;case"\n":a="\\n";break;case"\r":a="\\r";break;case'"':case"'":case"\\":case"%":a="\\"+d[0];break;default:continue}e+=b.slice(c,d.index)+a,c=matchEscSqlRx.lastIndex}return c<b.length?"'"+e+b.slice(c)+"'":"'"+e+"'"}!function(d,a){var b,c;if("object"==typeof exports&&"object"==typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{b=a();for(c in b)("object"==typeof exports?exports:d)[c]=b[c]}}(this,function(){return(()=>{"use strict";var c={870:(v,t,s)=>{s.r(t),s.d(t,{createEndpoint:()=>n,expose:()=>d,proxy:()=>r,proxyMarker:()=>e,releaseProxy:()=>m,transfer:()=>q,transferHandlers:()=>i,windowEndpoint:()=>u,wrap:()=>j});const e=Symbol("Comlink.proxy"),n=Symbol("Comlink.endpoint"),m=Symbol("Comlink.releaseProxy"),g=Symbol("Comlink.thrown"),l=a=>"object"==typeof a&&null!==a||"function"==typeof a,i=new Map([["proxy",{canHandle:a=>l(a)&&a[e],serialize(b){const{port1:c,port2:a}=new MessageChannel;return d(b,c),[a,[a]]},deserialize:a=>(a.start(),j(a))}],["throw",{canHandle:a=>l(a)&&g in a,serialize({value:a}){let b;return b=a instanceof Error?{isError:!0,value:{message:a.message,name:a.name,stack:a.stack}}:{isError:!1,value:a},[b,[]]},deserialize(a){throw a.isError?Object.assign(new Error(a.value.message),a.value):a.value}}]]);function d(c,b=self){b.addEventListener("message",function n(f){if(!f||!f.data)return;const{id:m,type:j,path:i}=Object.assign({path:[]},f.data),l=(f.data.argumentList||[]).map(a);let e;try{const g=i.slice(0,-1).reduce((a,b)=>a[b],c),b=i.reduce((a,b)=>a[b],c);switch(j){case 0:e=b;break;case 1:g[i.slice(-1)[0]]=a(f.data.value),e=!0;break;case 2:e=b.apply(g,l);break;case 3:e=r(new b(...l));break;case 4:{const{port1:a,port2:b}=new MessageChannel;d(c,b),e=q(a,[a])}break;case 5:e=void 0}}catch(a){e={value:a,[g]:0}}Promise.resolve(e).catch(a=>({value:a,[g]:0})).then(a=>{const[c,d]=h(a);b.postMessage(Object.assign(Object.assign({},c),{id:m}),d),5===j&&(b.removeEventListener("message",n),k(b))})}),b.start&&b.start()}function k(a){(function(a){return"MessagePort"===a.constructor.name})(a)&&a.close()}function j(a,b){return f(a,[],b)}function c(a){if(a)throw new Error("Proxy has been released and is not useable")}function f(e,d=[],j=function(){}){let g=!1;const i=new Proxy(j,{get(j,h){if(c(g),h===m)return()=>b(e,{type:5,path:d.map(a=>a.toString())}).then(()=>{k(e),g=!0});if("then"===h){if(0===d.length)return{then:()=>i};const c=b(e,{type:0,path:d.map(a=>a.toString())}).then(a);return c.then.bind(c)}return f(e,[...d,h])},set(l,f,i){c(g);const[j,k]=h(i);return b(e,{type:1,path:[...d,f].map(a=>a.toString()),value:j},k).then(a)},apply(l,m,i){c(g);const h=d[d.length-1];if(h===n)return b(e,{type:4}).then(a);if("bind"===h)return f(e,d.slice(0,-1));const[j,k]=o(i);return b(e,{type:2,path:d.map(a=>a.toString()),argumentList:j},k).then(a)},construct(j,f){c(g);const[h,i]=o(f);return b(e,{type:3,path:d.map(a=>a.toString()),argumentList:h},i).then(a)}});return i}function o(c){const a=c.map(h);return[a.map(a=>a[0]),(b=a.map(a=>a[1]),Array.prototype.concat.apply([],b))];var b}const p=new WeakMap;function q(a,b){return p.set(a,b),a}function r(a){return Object.assign(a,{[e]:!0})}function u(b,a=self,c="*"){return{postMessage:(a,d)=>b.postMessage(a,c,d),addEventListener:a.addEventListener.bind(a),removeEventListener:a.removeEventListener.bind(a)}}function h(a){for(const[c,b]of i)if(b.canHandle(a)){const[d,e]=b.serialize(a);return[{type:3,name:c,value:d},e]}return[{type:0,value:a},p.get(a)||[]]}function a(a){switch(a.type){case 3:return i.get(a.name).deserialize(a.value);case 0:return a.value}}function b(a,b,c){return new Promise(e=>{const d=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");a.addEventListener("message",function c(b){b.data&&b.data.id&&b.data.id===d&&(a.removeEventListener("message",c),e(b.data))}),a.start&&a.start(),a.postMessage(Object.assign({id:d},b),c)})}},162:function(k,b,h){var i=this&&this.__createBinding||(Object.create?function(c,d,b,a){void 0===a&&(a=b),Object.defineProperty(c,a,{enumerable:!0,get:function(){return d[b]}})}:function(c,d,b,a){void 0===a&&(a=b),c[a]=d[b]}),e=this&&this.__setModuleDefault||(Object.create?function(a,b){Object.defineProperty(a,"default",{enumerable:!0,value:b})}:function(a,b){a.default=b}),f=this&&this.__importStar||function(a){var b,c;if(a&&a.__esModule)return a;if(b={},null!=a)for(c in a)"default"!==c&&Object.prototype.hasOwnProperty.call(a,c)&&i(b,a,c);return e(b,a),b};Object.defineProperty(b,"__esModule",{value:!0}),b.createDbWorker=void 0;const a=f(h(870));async function g(a){if(a.data&&"eval"===a.data.action){const c=new Int32Array(a.data.notify,0,2),e=new Uint8Array(a.data.notify,8);let b;try{b={ok:await j(a.data.request)}}catch(c){console.error("worker request error",a.data.request,c),b={err:String(c)}}const d=(new TextEncoder).encode(JSON.stringify(b));e.set(d,0),c[1]=d.length,Atomics.notify(c,0)}}function c(a){if("BODY"===a.tagName)return"body";const b=[];for(;a.parentElement&&"BODY"!==a.tagName;){if(a.id){b.unshift("#"+a.id);break}{let d=1,c=a;for(;c.previousElementSibling;)c=c.previousElementSibling,d++;b.unshift(a.tagName.toLowerCase()+":nth-child("+d+")")}a=a.parentElement}return b.join(" > ")}function d(a){return Object.keys(a)}async function j(a){if(console.log("dom vtable request",a),"select"===a.type)return[...document.querySelectorAll(a.selector)].map(b=>{const d={};for(const e of a.columns)"selector"===e?d.selector=c(b):"parent"===e?b.parentElement&&(d.parent=b.parentElement?c(b.parentElement):null):"idx"===e||(d[e]=b[e]);return d});if("insert"===a.type){if(!a.value.parent)throw Error('"parent" column must be set when inserting');const b=document.querySelectorAll(a.value.parent);if(0===b.length)throw Error(`Parent element ${a.value.parent} could not be found`);if(b.length>1)throw Error(`Parent element ${a.value.parent} ambiguous (${b.length} results)`);const e=b[0];if(!a.value.tagName)throw Error("tagName must be set for inserting");const c=document.createElement(a.value.tagName);for(const b of d(a.value))if(null!==a.value[b]){if("tagName"===b||"parent"===b)continue;if("idx"===b||"selector"===b)throw Error(`${b} can't be set`);c[b]=a.value[b]}return e.appendChild(c),null}if("update"===a.type){const b=document.querySelector(a.value.selector);if(!b)throw Error(`Element ${a.value.selector} not found!`);const e=[];for(const f of d(a.value)){const g=a.value[f];if("parent"!==f){if("idx"!==f&&"selector"!==f&&g!==b[f]){if(console.log("SETTING ",f,b[f],"->",g),"tagName"===f)throw Error("can't change tagName");e.push(f)}}else if(g!==c(b.parentElement)){const a=document.querySelectorAll(g);if(1!==a.length)throw Error(`Invalid target parent: found ${a.length} matches`);a[0].appendChild(b)}}for(const c of e)b[c]=a.value[c];return null}throw Error(`unknown request ${a.type}`)}a.transferHandlers.set("WORKERSQLPROXIES",{canHandle:a=>!1,serialize(a){throw Error("no")},deserialize:b=>(b.start(),a.wrap(b))}),b.createDbWorker=async function(b,e,f,h=1/0){const c=new Worker(e),d=a.wrap(c),i=await d.SplitFileHttpDatabase(f,b,void 0,h);return c.addEventListener("message",g),{db:i,worker:d,configs:b}}},432:function(e,a,b){var c=this&&this.__createBinding||(Object.create?function(c,d,b,a){void 0===a&&(a=b),Object.defineProperty(c,a,{enumerable:!0,get:function(){return d[b]}})}:function(c,d,b,a){void 0===a&&(a=b),c[a]=d[b]}),d=this&&this.__exportStar||function(b,d){for(var a in b)"default"===a||Object.prototype.hasOwnProperty.call(d,a)||c(d,b,a)};Object.defineProperty(a,"__esModule",{value:!0}),d(b(162),a)}},b={};function a(e){var f=b[e],d;return void 0!==f?f.exports:(d=b[e]={exports:{}},c[e].call(d.exports,d,d.exports,a),d.exports)}return a.d=(d,c)=>{for(var b in c)a.o(c,b)&&!a.o(d,b)&&Object.defineProperty(d,b,{enumerable:!0,get:c[b]})},a.o=(a,b)=>Object.prototype.hasOwnProperty.call(a,b),a.r=a=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(a,"__esModule",{value:!0})},a(432)})()});const audioContext=new AudioContext,audioBufferCache={};loadAudio("correct","mp3/correct3.mp3"),loadAudio("incorrect","mp3/incorrect1.mp3"),loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}async function playAudio(b,c){const d=await loadAudio(b,audioBufferCache[b]),a=audioContext.createBufferSource();if(a.buffer=d,c){const b=audioContext.createGain();b.gain.value=c,b.connect(audioContext.destination),a.connect(b),a.start()}else a.connect(audioContext.destination),a.start()}async function loadAudio(a,c){if(audioBufferCache[a])return audioBufferCache[a];const d=await fetch(c),e=await d.arrayBuffer(),b=await audioContext.decodeAudioData(e);return audioBufferCache[a]=b,b}function unlockAudio(){audioContext.resume()}function loadGrade(){const a=localStorage.getItem("rensole-zh");if(a){const b=document.getElementById("grade");[...b.options].forEach(b=>{b.value==a?b.selected=!0:b.selected=!1})}}function getWordVector(a){return rensoleWorker.db.query(`SELECT * FROM magnitude WHERE key="${escapeSql(a)}"`).then(a=>{if(a[0]){const b=new Array(300);for(const[c,d]of Object.entries(a[0]))if(c.startsWith("dim_")){const a=parseInt(c.slice(4));b[a]=d}return b}})}function getSiminyms(a){return siminymWorker.db.query(`SELECT words FROM siminyms WHERE lemma="${escapeSql(a)}"`).then(a=>{if(a[0]){const b=JSON.parse(a[0].words);return b.reverse()}})}function showHint(a){let b="";if(Object.keys(a).length==0)return b;const d=a.type=="word"?2:4,e=a.type=="word"?1:3,c=a.text;for(let f=0;f<c.length;f++)c[f]==a.target[f]?b+=`<span class="hint${d}">${c[f]}</span>`:b+=`<span class="hint${e}">${c[f]}</span>`;return b}function pronounceHint(c){if(c==1){const a=pronounce.map((a,b)=>[a,b]).filter(a=>!/^[a-z]$/.test(a[0])).map(a=>a[1]),b=a[getRandomInt(0,a.length)];return holedPronounce=pronounce.map((a,c)=>c==b?a:"?"),{text:holedPronounce,type:"pronounce",target:pronounce}}const b=pronounce.map((a,b)=>[a,b]).filter((b,a)=>holedPronounce[a]=="?").filter(a=>!/^[a-z]$/.test(a[0])).map(a=>a[1]),a=b[getRandomInt(0,b.length)];return a&&(holedPronounce[a]=pronounce[a]),{text:holedPronounce,type:"pronounce",target:pronounce}}function wordHint(a){switch(a){case 1:{let a="";for(let b=0;b<answer.length;b++)a+="？";return holedAnswer=a,{text:a,type:"word",target:answer}}case 2:{const a=getRandomInt(0,answer.length);return holedAnswer=holedAnswer.slice(0,a)+answer[a]+holedAnswer.slice(a+1),{text:holedAnswer,type:"word",target:answer}}default:{if(answer.length>a){const b=holedAnswer.split("").map((a,b)=>[a,b]).filter(a=>a[0]=="？").map(a=>a[1]),a=b[getRandomInt(0,b.length)];return holedAnswer=holedAnswer.slice(0,a)+answer[a]+holedAnswer.slice(a+1),{text:holedAnswer,type:"word",target:answer}}return{}}}}function getHint(a){switch(a){case 1:return wordHint(1);case 3:return pronounceHint(1);case 5:return wordHint(2);case 7:return pronounceHint(2);case 9:return wordHint(3);default:return{}}}function showAnswer(c){c?playAudio(correctAudio):playAudio(incorrectAudio),document.getElementById("answer").classList.remove("d-none");const a=["bounce","rubberBand","flip","rotateIn","swing","tada","heartBeat","jackInTheBox"],d=a[getRandomInt(0,a.length)],e=["animate__animated",`animate__${d}`],b=document.getElementById("answerText");b.textContent=answer,b.parentNode.classList.add(...e),document.getElementById("restart").focus()}function norm(a){let b=0;for(let c=0;c<a.length;c++)b+=Math.pow(a[c],2);const c=Math.sqrt(b);return c}function dot(a,b){if(a.length!==b.length)throw new Error("The vectors have different lengths.");let c=0;for(let d=0;d<a.length;d++)c+=a[d]*b[d];return c}function search(){const b=document.getElementById("searchText"),a=b.value;getWordVector(a).then(c=>{if(c){if(document.getElementById("notExisted").classList.add("invisible"),replyCount>=10)a==answer?showAnswer(!0):showAnswer(!1);else{const b=answerVector,g=dot(b,c)/(norm(b)*norm(c)),d=document.createElement("template"),e=mostSimilars[replyCount],h=getHint(replyCount);d.innerHTML=`
          <tr>
            <td>${a}</td><td>${g.toFixed(3)}</td>
            <td>${e[0]}</td><td>${e[1].toFixed(3)}</td>
            <td>${showHint(h)}</td></td>
          </tr>
        `;const f=document.getElementById("renso"),i=d.content.firstElementChild;f.insertBefore(i,f.firstChild),a==answer&&showAnswer(!0)}replyCount+=1}else document.getElementById("notExisted").classList.remove("invisible");b.value=""})}function getRandomInt(a,b){return a=Math.ceil(a),b=Math.floor(b),Math.floor(Math.random()*(b-a))+a}function loadProblems(){return fetch("pronounce.tsv").then(a=>a.text()).then(b=>{document.getElementById("loading").classList.remove("d-none");const a=b.trimEnd().split("\n");gradePoses=a[0].split(",").map(a=>parseInt(a)),a.slice(1).forEach(a=>{vocabularies.push(a.split("	"))}),loadWorkers()})}function loadSiminymWorker(){let a=localStorage.getItem("rensole-zh");if(!a){const b=document.getElementById("grade");a=b.options[b.selectedIndex].value}const b={from:"jsonconfig",configUrl:`/siminym-zh/db/${a}/config.json`};return createDbWorker([b],"/siminym-zh/sql.js-httpvfs/sqlite.worker.js","/siminym-zh/sql.js-httpvfs/sql-wasm.wasm")}function loadRensoWorker(){const a={from:"jsonconfig",configUrl:"/rensole-zh/db/config.json"};return createDbWorker([a],"/rensole-zh/sql.js-httpvfs/sqlite.worker.js","/rensole-zh/sql.js-httpvfs/sql-wasm.wasm")}function loadProblemVectors(){const a=[getSiminyms(answer),getWordVector(answer)];return Promise.all(a).then(a=>{mostSimilars=a[0],answerVector=a[1],document.getElementById("searchText").focus(),document.getElementById("loading").classList.add("d-none")})}async function changeProblem(){document.getElementById("loading").classList.remove("d-none"),document.getElementById("answer").classList.add("d-none"),replyCount=0;const a=getRandomInt(0,problems.length);answer=problems[a][0],pronounce=problems[a][1].replace(/ /g,"").split("");const b=document.getElementById("renso");while(b.firstChild)b.firstChild.remove();await loadProblemVectors()}async function loadWorkers(){const a=document.getElementById("grade"),b=gradePoses[a.selectedIndex];problems=vocabularies.slice(0,b);const c=[loadSiminymWorker(),loadRensoWorker()];await Promise.all(c).then(a=>{siminymWorker=a[0],rensoleWorker=a[1],changeProblem()})}function changeGrade(){const a=document.getElementById("grade"),b=a.options[a.selectedIndex].value;localStorage.setItem("rensole-zh",b),location.reload()}const vocabularies=[];let gradePoses=[],problems=[],replyCount=0,mostSimilars,answerVector,answer,pronounce,holedAnswer,holedPronounce,rensoleWorker,siminymWorker;loadGrade(),loadProblems(),document.addEventListener("keydown",a=>{a.key=="Enter"&&search()}),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("search").onclick=search,document.getElementById("restart").onclick=changeProblem,document.getElementById("grade").onchange=changeGrade,document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})