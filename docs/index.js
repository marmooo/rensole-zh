const matchEscSqlRx=/[\0\b\t\n\r\x1a"'\\]/g;function escapeSql(e){const i=matchEscSqlRx.exec(e);if(!i)return e;let n=matchEscSqlRx.lastIndex=0,o="",s,t;for(;s=matchEscSqlRx.exec(e);){switch(s[0]){case"\0":t="\\0";break;case"":t="\\b";break;case"	":t="\\t";break;case"":t="\\z";break;case`
`:t=`\\n`;break;case``:t=`\\r`;break;case'"':case"'":case"\\":case"%":t="\\"+s[0];break;default:continue}o+=e.slice(n,s.index)+t,n=matchEscSqlRx.lastIndex}return n<e.length?"'"+o+e.slice(n)+"'":"'"+o+"'"}!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var s,n=t();for(s in n)("object"==typeof exports?exports:e)[s]=n[s]}}(this,function(){return(()=>{"use strict";var n={870:(e,t,n)=>{n.r(t),n.d(t,{createEndpoint:()=>y,expose:()=>l,proxy:()=>v,proxyMarker:()=>u,releaseProxy:()=>j,transfer:()=>g,transferHandlers:()=>c,windowEndpoint:()=>_,wrap:()=>h});const u=Symbol("Comlink.proxy"),y=Symbol("Comlink.endpoint"),j=Symbol("Comlink.releaseProxy"),a=Symbol("Comlink.thrown"),b=e=>"object"==typeof e&&null!==e||"function"==typeof e,c=new Map([["proxy",{canHandle:e=>b(e)&&e[u],serialize(e){const{port1:n,port2:t}=new MessageChannel;return l(e,n),[t,[t]]},deserialize:e=>(e.start(),h(e))}],["throw",{canHandle:e=>b(e)&&a in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}}]]);function l(e,t=self){t.addEventListener("message",function n(o){if(!o||!o.data)return;const{id:h,type:d,path:c}=Object.assign({path:[]},o.data),u=(o.data.argumentList||[]).map(s);let i;try{const n=c.slice(0,-1).reduce((e,t)=>e[t],e),t=c.reduce((e,t)=>e[t],e);switch(d){case 0:i=t;break;case 1:n[c.slice(-1)[0]]=s(o.data.value),i=!0;break;case 2:i=t.apply(n,u);break;case 3:i=v(new t(...u));break;case 4:{const{port1:t,port2:n}=new MessageChannel;l(e,n),i=g(t,[t])}break;case 5:i=void 0}}catch(e){i={value:e,[a]:0}}Promise.resolve(i).catch(e=>({value:e,[a]:0})).then(e=>{const[s,o]=r(e);t.postMessage(Object.assign(Object.assign({},s),{id:h}),o),5===d&&(t.removeEventListener("message",n),m(t))})}),t.start&&t.start()}function m(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function h(e,t){return d(e,[],t)}function i(e){if(e)throw new Error("Proxy has been released and is not useable")}function d(e,t=[],n=function(){}){let a=!1;const c=new Proxy(n,{get(n,r){if(i(a),r===j)return()=>o(e,{type:5,path:t.map(e=>e.toString())}).then(()=>{m(e),a=!0});if("then"===r){if(0===t.length)return{then:()=>c};const n=o(e,{type:0,path:t.map(e=>e.toString())}).then(s);return n.then.bind(n)}return d(e,[...t,r])},set(n,c,l){i(a);const[d,u]=r(l);return o(e,{type:1,path:[...t,c].map(e=>e.toString()),value:d},u).then(s)},apply(n,r,c){i(a);const l=t[t.length-1];if(l===y)return o(e,{type:4}).then(s);if("bind"===l)return d(e,t.slice(0,-1));const[u,h]=f(c);return o(e,{type:2,path:t.map(e=>e.toString()),argumentList:u},h).then(s)},construct(n,r){i(a);const[c,l]=f(r);return o(e,{type:3,path:t.map(e=>e.toString()),argumentList:c},l).then(s)}});return c}function f(e){const t=e.map(r);return[t.map(e=>e[0]),(n=t.map(e=>e[1]),Array.prototype.concat.apply([],n))];var n}const p=new WeakMap;function g(e,t){return p.set(e,t),e}function v(e){return Object.assign(e,{[u]:!0})}function _(e,t=self,n="*"){return{postMessage:(t,s)=>e.postMessage(t,n,s),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function r(e){for(const[n,t]of c)if(t.canHandle(e)){const[s,o]=t.serialize(e);return[{type:3,name:n,value:s},o]}return[{type:0,value:e},p.get(e)||[]]}function s(e){switch(e.type){case 3:return c.get(e.name).deserialize(e.value);case 0:return e.value}}function o(e,t,n){return new Promise(s=>{const o=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");e.addEventListener("message",function t(n){n.data&&n.data.id&&n.data.id===o&&(e.removeEventListener("message",t),s(n.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:o},t),n)})}},162:function(e,t,n){var a=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),c=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var n,t={};if(e!=null)for(n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&a(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.createDbWorker=void 0;const s=c(n(870));async function l(e){if(e.data&&"eval"===e.data.action){const n=new Int32Array(e.data.notify,0,2),o=new Uint8Array(e.data.notify,8);let t;try{t={ok:await d(e.data.request)}}catch(n){console.error("worker request error",e.data.request,n),t={err:String(n)}}const s=(new TextEncoder).encode(JSON.stringify(t));o.set(s,0),n[1]=s.length,Atomics.notify(n,0)}}function o(e){if("BODY"===e.tagName)return"body";const t=[];for(;e.parentElement&&"BODY"!==e.tagName;){if(e.id){t.unshift("#"+e.id);break}{let s=1,n=e;for(;n.previousElementSibling;)n=n.previousElementSibling,s++;t.unshift(e.tagName.toLowerCase()+":nth-child("+s+")")}e=e.parentElement}return t.join(" > ")}function i(e){return Object.keys(e)}async function d(e){if(console.log("dom vtable request",e),"select"===e.type)return[...document.querySelectorAll(e.selector)].map(t=>{const n={};for(const s of e.columns)"selector"===s?n.selector=o(t):"parent"===s?t.parentElement&&(n.parent=t.parentElement?o(t.parentElement):null):"idx"===s||(n[s]=t[s]);return n});if("insert"===e.type){if(!e.value.parent)throw Error('"parent" column must be set when inserting');const t=document.querySelectorAll(e.value.parent);if(0===t.length)throw Error(`Parent element ${e.value.parent} could not be found`);if(t.length>1)throw Error(`Parent element ${e.value.parent} ambiguous (${t.length} results)`);const s=t[0];if(!e.value.tagName)throw Error("tagName must be set for inserting");const n=document.createElement(e.value.tagName);for(const t of i(e.value))if(null!==e.value[t]){if("tagName"===t||"parent"===t)continue;if("idx"===t||"selector"===t)throw Error(`${t} can't be set`);n[t]=e.value[t]}return s.appendChild(n),null}if("update"===e.type){const t=document.querySelector(e.value.selector);if(!t)throw Error(`Element ${e.value.selector} not found!`);const n=[];for(const s of i(e.value)){const a=e.value[s];if("parent"!==s){if("idx"!==s&&"selector"!==s&&a!==t[s]){if(console.log("SETTING ",s,t[s],"->",a),"tagName"===s)throw Error("can't change tagName");n.push(s)}}else if(a!==o(t.parentElement)){const e=document.querySelectorAll(a);if(1!==e.length)throw Error(`Invalid target parent: found ${e.length} matches`);e[0].appendChild(t)}}for(const s of n)t[s]=e.value[s];return null}throw Error(`unknown request ${e.type}`)}s.transferHandlers.set("WORKERSQLPROXIES",{canHandle:e=>!1,serialize(){throw Error("no")},deserialize:e=>(e.start(),s.wrap(e))}),t.createDbWorker=async function(e,t,n,o=1/0){const i=new Worker(t),a=s.wrap(i),r=await a.SplitFileHttpDatabase(n,e,void 0,o);return i.addEventListener("message",l),{db:r,worker:a,configs:e}}},432:function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(162),t)}},t={};function e(s){var o,i=t[s];return void 0!==i?i.exports:(o=t[s]={exports:{}},n[s].call(o.exports,o,o.exports,e),o.exports)}return e.d=(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e(432)})()});const audioContext=new AudioContext,audioBufferCache={};loadAudio("correct","mp3/correct3.mp3"),loadAudio("incorrect","mp3/incorrect1.mp3"),loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}async function playAudio(e,t){const s=await loadAudio(e,audioBufferCache[e]),n=audioContext.createBufferSource();if(n.buffer=s,t){const e=audioContext.createGain();e.gain.value=t,e.connect(audioContext.destination),n.connect(e),n.start()}else n.connect(audioContext.destination),n.start()}async function loadAudio(e,t){if(audioBufferCache[e])return audioBufferCache[e];const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}function unlockAudio(){audioContext.resume()}function loadGrade(){const e=localStorage.getItem("rensole-zh");if(e){const t=document.getElementById("grade");[...t.options].forEach(t=>{t.value==e?t.selected=!0:t.selected=!1})}}function getWordVector(e){return rensoleWorker.db.query(`SELECT * FROM magnitude WHERE key="${escapeSql(e)}"`).then(e=>{if(e[0]){const t=new Array(300);for(const[n,s]of Object.entries(e[0]))if(n.startsWith("dim_")){const e=parseInt(n.slice(4));t[e]=s}return t}})}function getSiminyms(e){return siminymWorker.db.query(`SELECT words FROM siminyms WHERE lemma="${escapeSql(e)}"`).then(e=>{if(e[0]){const t=JSON.parse(e[0].words);return t.reverse()}})}function showHint(e){let t="";if(Object.keys(e).length==0)return t;const s=e.type=="word"?2:4,o=e.type=="word"?1:3,n=e.text;for(let i=0;i<n.length;i++)n[i]==e.target[i]?t+=`<span class="hint${s}">${n[i]}</span>`:t+=`<span class="hint${o}">${n[i]}</span>`;return t}function pronounceHint(e){if(e==1){const e=pronounce.map((e,t)=>[e,t]).filter(e=>!/^[a-z]$/.test(e[0])).map(e=>e[1]),t=e[getRandomInt(0,e.length)];return holedPronounce=pronounce.map((e,n)=>n==t?e:"?"),{text:holedPronounce,type:"pronounce",target:pronounce}}const n=pronounce.map((e,t)=>[e,t]).filter((e,t)=>holedPronounce[t]=="?").filter(e=>!/^[a-z]$/.test(e[0])).map(e=>e[1]),t=n[getRandomInt(0,n.length)];return t&&(holedPronounce[t]=pronounce[t]),{text:holedPronounce,type:"pronounce",target:pronounce}}function wordHint(e){switch(e){case 1:{let e="";for(let t=0;t<answer.length;t++)e+="？";return holedAnswer=e,{text:e,type:"word",target:answer}}case 2:{const e=getRandomInt(0,answer.length);return holedAnswer=holedAnswer.slice(0,e)+answer[e]+holedAnswer.slice(e+1),{text:holedAnswer,type:"word",target:answer}}default:{if(answer.length>e){const t=holedAnswer.split("").map((e,t)=>[e,t]).filter(e=>e[0]=="？").map(e=>e[1]),e=t[getRandomInt(0,t.length)];return holedAnswer=holedAnswer.slice(0,e)+answer[e]+holedAnswer.slice(e+1),{text:holedAnswer,type:"word",target:answer}}return{}}}}function getHint(e){switch(e){case 1:return wordHint(1);case 3:return pronounceHint(1);case 5:return wordHint(2);case 7:return pronounceHint(2);case 9:return wordHint(3);default:return{}}}function showAnswer(e){e?playAudio("correct",.3):playAudio("incorrect",.3),document.getElementById("answer").classList.remove("d-none");const t=["bounce","rubberBand","flip","rotateIn","swing","tada","heartBeat","jackInTheBox"],s=t[getRandomInt(0,t.length)],o=["animate__animated",`animate__${s}`],n=document.getElementById("answerText");n.textContent=answer,n.parentNode.classList.add(...o),document.getElementById("restart").focus()}function norm(e){let t=0;for(let n=0;n<e.length;n++)t+=Math.pow(e[n],2);const n=Math.sqrt(t);return n}function dot(e,t){if(e.length!==t.length)throw new Error("The vectors have different lengths.");let n=0;for(let s=0;s<e.length;s++)n+=e[s]*t[s];return n}function search(){const t=document.getElementById("searchText"),e=t.value;getWordVector(e).then(n=>{if(n){if(document.getElementById("notExisted").classList.add("invisible"),replyCount>=10)showAnswer(e==answer);else{const t=answerVector,a=dot(t,n)/(norm(t)*norm(n)),s=document.createElement("template"),o=mostSimilars[replyCount],r=getHint(replyCount);s.innerHTML=`
          <tr>
            <td>${e}</td><td>${a.toFixed(3)}</td>
            <td>${o[0]}</td><td>${o[1].toFixed(3)}</td>
            <td>${showHint(r)}</td></td>
          </tr>
        `;const i=document.getElementById("renso"),c=s.content.firstElementChild;i.insertBefore(c,i.firstChild),e==answer&&showAnswer(!0)}replyCount+=1}else document.getElementById("notExisted").classList.remove("invisible");t.value=""})}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}function loadProblems(){return fetch("pronounce.tsv").then(e=>e.text()).then(e=>{document.getElementById("loading").classList.remove("d-none");const t=e.trimEnd().split(`
`);gradePoses=t[0].split(",").map(e=>parseInt(e)),t.slice(1).forEach(e=>{vocabularies.push(e.split("	"))}),loadWorkers()})}function loadSiminymWorker(){let e=localStorage.getItem("rensole-zh");if(!e){const t=document.getElementById("grade");e=t.options[t.selectedIndex].value}const t={from:"jsonconfig",configUrl:`/siminym-zh/db/${e}/config.json`};return createDbWorker([t],"/siminym-zh/sql.js-httpvfs/sqlite.worker.js","/siminym-zh/sql.js-httpvfs/sql-wasm.wasm")}function loadRensoWorker(){const e={from:"jsonconfig",configUrl:"/rensole-zh/db/config.json"};return createDbWorker([e],"/rensole-zh/sql.js-httpvfs/sqlite.worker.js","/rensole-zh/sql.js-httpvfs/sql-wasm.wasm")}function loadProblemVectors(){const e=[getSiminyms(answer),getWordVector(answer)];return Promise.all(e).then(e=>{mostSimilars=e[0],answerVector=e[1],document.getElementById("searchText").focus(),document.getElementById("loading").classList.add("d-none")})}async function changeProblem(){document.getElementById("loading").classList.remove("d-none"),document.getElementById("answer").classList.add("d-none"),replyCount=0;const e=getRandomInt(0,problems.length);answer=problems[e][0],pronounce=problems[e][1].replace(/ /g,"").split("");const t=document.getElementById("renso");for(;t.firstChild;)t.firstChild.remove();await loadProblemVectors()}async function loadWorkers(){const e=document.getElementById("grade"),t=gradePoses[e.selectedIndex];problems=vocabularies.slice(0,t);const n=[loadSiminymWorker(),loadRensoWorker()];await Promise.all(n).then(e=>{siminymWorker=e[0],rensoleWorker=e[1],changeProblem()})}function changeGrade(){const e=document.getElementById("grade"),t=e.options[e.selectedIndex].value;localStorage.setItem("rensole-zh",t),location.reload()}const vocabularies=[];let gradePoses=[],problems=[],replyCount=0,mostSimilars,answerVector,answer,pronounce,holedAnswer,holedPronounce,rensoleWorker,siminymWorker;loadGrade(),loadProblems(),document.addEventListener("keydown",e=>{e.key=="Enter"&&search()}),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("search").onclick=search,document.getElementById("restart").onclick=changeProblem,document.getElementById("grade").onchange=changeGrade,document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})